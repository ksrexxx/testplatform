# Архитектура системы

## Обзор

Exam Platform Backend - это полнофункциональная серверная система для проведения пробных и экзаменационных тестов. Архитектура построена на микросервисном подходе с разделением ответственности между компонентами.

## Компоненты системы

### 1. API Server (FastAPI)
- **Назначение:** Обработка HTTP-запросов от клиентов
- **Технологии:** FastAPI, Uvicorn, Pydantic v2
- **Порт:** 8000
- **Особенности:**
  - Асинхронная обработка запросов
  - Автоматическая генерация OpenAPI/Swagger документации
  - Валидация входных данных через Pydantic
  - JWT-аутентификация
  - RBAC middleware для контроля доступа
  - Структурированное JSON-логирование

### 2. PostgreSQL Database
- **Назначение:** Хранение всех данных системы
- **Версия:** 15+
- **Порт:** 5432
- **Схема данных:**
  - Пользователи и роли
  - Справочники (специальности, предметы)
  - Банки вопросов с версионированием
  - Вопросы, варианты ответов, правильные ответы
  - Шаблоны и инстансы экзаменов
  - Попытки экзаменов с детализацией по вопросам
  - События прокторинга
  - Аудит-логи

### 3. Redis
- **Назначение:** 
  - Кэширование данных
  - Брокер сообщений для Celery
  - Хранение результатов задач Celery
- **Версия:** 7+
- **Порт:** 6379
- **Использование:**
  - Кэш метаданных банков вопросов
  - Кэш подготовленных payload вопросов (без ответов)
  - Оперативное состояние попыток экзаменов

### 4. Celery Worker
- **Назначение:** Асинхронная обработка длительных задач
- **Задачи:**
  - Импорт вопросов из Excel
  - Генерация отчётов (CSV/XLSX)
- **Особенности:**
  - Параллельная обработка задач
  - Повторные попытки при ошибках
  - Отслеживание статуса выполнения

### 5. Celery Beat
- **Назначение:** Планировщик периодических задач
- **Задачи:**
  - Очистка устаревших сессий
  - Архивация старых попыток
  - Периодические проверки целостности данных

## Архитектурные паттерны

### 1. Layered Architecture (Слоистая архитектура)

```
┌─────────────────────────────────────┐
│     API Layer (FastAPI Routers)    │  ← HTTP endpoints
├─────────────────────────────────────┤
│    Business Logic (Services)        │  ← Бизнес-логика
├─────────────────────────────────────┤
│      Data Access (Models)           │  ← SQLAlchemy ORM
├─────────────────────────────────────┤
│         Database (PostgreSQL)       │  ← Хранилище данных
└─────────────────────────────────────┘
```

### 2. Repository Pattern
- Изоляция бизнес-логики от деталей доступа к данным
- Все операции с БД через SQLAlchemy ORM
- Использование транзакций для атомарности операций

### 3. Service Layer Pattern
- Вся бизнес-логика в отдельных сервисах
- Сервисы независимы от API-слоя
- Повторное использование логики

### 4. Dependency Injection
- FastAPI Depends для инъекции зависимостей
- get_db() для сессий БД
- get_current_user() для аутентификации

## Потоки данных

### Импорт вопросов из Excel

```
┌─────────┐   1. Upload  ┌─────────┐   2. Create Task   ┌────────┐
│  Admin  │─────────────→│   API   │───────────────────→│ Celery │
└─────────┘              └─────────┘                     └────────┘
                              ↓                              ↓
                         3. Return                      4. Process
                          Task ID                         Excel
                              ↓                              ↓
                         5. Poll Status              5. Validate
                              ←                              ↓
                         6. Get Result              6. Create Bank
                              ←                              ↓
                                                    7. Insert Questions
                                                             ↓
                                                      8. Save Results
```

### Прохождение экзамена

```
┌──────────┐   1. Start    ┌─────────┐   2. Generate    ┌──────────┐
│ Student  │──────────────→│   API   │─────────────────→│ Database │
└──────────┘               └─────────┘                   └──────────┘
     ↓                          ↑                              ↓
3. Get Questions                │                      4. Select Questions
     ↓                          │                              ↓
4. Display                      │                      5. Shuffle Options
     ↓                          │                              ↓
5. Answer                  6. Submit Answer            6. Store Answer
     ↓                          ↑                              
6. Submit Attempt          7. Calculate Score                  
     ↓                          ↓                              
7. View Results            8. Return Score                     
```

### Прокторинг

```
┌──────────┐   Events     ┌─────────┐    Store     ┌──────────┐
│ Client   │─────────────→│   API   │─────────────→│ Database │
│ (JS)     │              └─────────┘              └──────────┘
└──────────┘                   ↓                         ↓
     ↓                    Calculate                  Aggregate
     │                      Score                      Events
     │                         ↓                         ↓
     └──────────────── Get Summary ←──────────────  Compute Level
```

## Безопасность

### 1. Аутентификация
- JWT токены (HS256)
- Короткое время жизни (30 минут по умолчанию)
- Токены в HTTP-only заголовках

### 2. Авторизация (RBAC)
- Три роли: admin, curator, student
- Проверка ролей через middleware
- Иерархия доступа:
  - admin: полный доступ
  - curator: просмотр результатов + отчёты
  - student: только свои попытки

### 3. Защита правильных ответов
- Правильные ответы **НИКОГДА** не отправляются на клиент
- Серверная перемешка вариантов
- Проверка ответов только на сервере
- answer_nonce для идемпотентности

### 4. Валидация данных
- Pydantic схемы для всех входных данных
- Типизация на уровне Python
- Автоматические проверки формата

### 5. SQL Injection Protection
- Использование SQLAlchemy ORM
- Параметризованные запросы
- Никаких сырых SQL-запросов с пользовательским вводом

### 6. Rate Limiting
- Ограничение частоты запросов
- Защита от DDoS
- Настраиваемые лимиты для разных эндпоинтов

### 7. Аудит
- Логирование всех критичных операций
- audit_logs таблица для отслеживания
- IP-адреса и временные метки

## Масштабирование

### Горизонтальное масштабирование

1. **API Servers**
   - Stateless дизайн
   - Можно запустить несколько инстансов
   - Load balancer (Nginx/HAProxy) перед API

2. **Celery Workers**
   - Легко добавить больше воркеров
   - Автоматическое распределение задач
   - Разные очереди для разных типов задач

3. **Database**
   - PostgreSQL репликация (master-slave)
   - Read replicas для read-heavy операций
   - Connection pooling через PgBouncer

4. **Redis**
   - Redis Cluster для масштабирования
   - Redis Sentinel для высокой доступности

### Вертикальное масштабирование

- Увеличение ресурсов серверов
- Оптимизация индексов БД
- Настройка connection pools
- Кэширование на уровне приложения

## Производительность

### Оптимизации

1. **Database**
   - Индексы на часто используемых полях
   - Eager loading для связанных данных
   - Pagination для больших выборок

2. **Caching**
   - Redis для кэширования метаданных
   - Кэш подготовленных вопросов
   - TTL для автоматического истечения

3. **Async Processing**
   - Celery для длительных операций
   - Неблокирующие операции в API

4. **Connection Pooling**
   - SQLAlchemy connection pool
   - Redis connection pool
   - Оптимальные размеры пулов

## Мониторинг и логирование

### Логирование

- **Структурированные JSON-логи**
  - timestamp, level, logger, message
  - user_id, request_id для трассировки
  
- **Уровни логирования:**
  - INFO: нормальные операции
  - WARNING: потенциальные проблемы
  - ERROR: ошибки с stack traces
  
### Мониторинг (рекомендации для продакшена)

- **Метрики:**
  - Количество запросов
  - Время ответа API
  - Длина очередей Celery
  - Использование БД/Redis
  
- **Алерты:**
  - Высокая нагрузка
  - Ошибки 5xx
  - Долгие задачи Celery
  - Переполнение очередей

- **Инструменты:**
  - Prometheus для сбора метрик
  - Grafana для визуализации
  - Sentry для трассировки ошибок
  - ELK Stack для анализа логов

## Развёртывание

### Development
```bash
docker-compose up -d
```

### Production

1. **Контейнеризация**
   - Docker images для всех сервисов
   - Docker Compose / Kubernetes для оркестрации

2. **Переменные окружения**
   - Secrets management (Vault, AWS Secrets Manager)
   - Разные конфиги для разных окружений

3. **HTTPS**
   - Nginx reverse proxy с SSL
   - Let's Encrypt сертификаты

4. **Backup**
   - Автоматические бэкапы PostgreSQL
   - Репликация для disaster recovery

5. **CI/CD**
   - GitHub Actions / GitLab CI
   - Автоматические тесты
   - Deployment pipelines

## Будущие улучшения

1. **Функциональные:**
   - Поддержка видео-прокторинга
   - Adaptive testing (CAT)
   - Детальная аналитика для преподавателей
   - API для интеграций с LMS

2. **Технические:**
   - GraphQL API
   - WebSocket для real-time обновлений
   - Elasticsearch для полнотекстового поиска
   - Message queue (RabbitMQ) вместо Redis для Celery

3. **Безопасность:**
   - OAuth2/OIDC интеграция
   - 2FA для администраторов
   - Шифрование sensitive данных at rest
   - Regular security audits

## Заключение

Архитектура разработана с учётом:
- **Безопасности:** защита данных и предотвращение мошенничества
- **Масштабируемости:** горизонтальное и вертикальное масштабирование
- **Производительности:** оптимизация для высокой нагрузки
- **Надёжности:** fault tolerance и graceful degradation
- **Поддерживаемости:** чистый код и документация
